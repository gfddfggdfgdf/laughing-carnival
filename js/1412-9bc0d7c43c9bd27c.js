!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="cbb274bb-a31f-49c0-90a9-9f75a24ce5ac",e._sentryDebugIdIdentifier="sentry-dbid-cbb274bb-a31f-49c0-90a9-9f75a24ce5ac")}catch(e){}}();"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1412],{169:(e,t,n)=>{n.d(t,{A:()=>s});var a=n(95155);n(12115);var r=n(30383);let s=e=>{let{isLoading:t,children:n,...s}=e;return t?(0,a.jsx)(r.A,{...s}):n}},2304:(e,t,n)=>{n.d(t,{s:()=>i});var a=n(18835),r=n(12861),s=n(44950);let i=(0,r.io)(a.K.REST_API_ENDPOINT,{autoConnect:!1,withCredentials:!0,reconnection:!0,reconnectionAttempts:1/0,tryAllTransports:!0,rememberUpgrade:!0,transports:[s.Fp,s.kb],reconnectionDelay:1e3,reconnectionDelayMax:5e3,randomizationFactor:.5})},9136:(e,t,n)=>{n.d(t,{X6:()=>g,zj:()=>d,hi:()=>v,ws:()=>f});var a=n(2304),r=n(42592),s=n.n(r);let i=JSON.parse('{"type":"record","name":"MessageForClient","fields":[{"name":"inner","type":[{"type":"record","name":"BeginMessage","fields":[{"name":"message_id","type":"long"},{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"authored_by","type":"string"},{"name":"references_id","type":["long","null"]},{"name":"timestamp","type":{"type":"long","logicalType":"timestamp-millis"}},{"name":"status","type":{"type":"enum","name":"MessageStatus","symbols":["deleted","created","user_changed","regenerated"]}}]},{"type":"record","name":"PartialMessage","fields":[{"name":"message_id","type":"long"},{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"content","type":["string","null"]},{"name":"metadata","type":["string","null"]},{"name":"sequence_no","type":"long"},{"name":"status","type":"MessageStatus"}]},{"type":"record","name":"EndMessage","fields":[{"name":"message_id","type":"long"},{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"authored_by","type":"string"},{"name":"references_id","type":["long","null"]},{"name":"sequence_max","type":"long"},{"name":"timestamp","type":{"type":"long","logicalType":"timestamp-millis"}}]},{"type":"record","name":"MessagePublic","fields":[{"name":"message_id","type":"long"},{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"timestamp","type":{"type":"long","logicalType":"timestamp-millis"}},{"name":"status","type":"MessageStatus"},{"name":"author_slug","type":"string"},{"name":"author_type","type":{"type":"enum","name":"AuthorType","symbols":["user","llm"]}},{"name":"author_name","type":"string"},{"name":"editor_name","type":["null","string"],"default":null},{"name":"content_type","type":{"type":"enum","name":"ContentType","symbols":["null","text","image","audio"]}},{"name":"content","type":["null","string"],"default":null},{"name":"metadata","type":["null","string"],"default":null},{"name":"references_id","type":["null","long"],"default":null}]},{"type":"record","name":"Typing","fields":[{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"authored_by","type":"string"},{"name":"timestamp","type":{"type":"long","logicalType":"timestamp-millis"}}]},{"type":"record","name":"UpdatedConversation","fields":[{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"conversation","type":{"type":"record","name":"ConversationMultiDetails","fields":[{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"name","type":["string","null"]},{"name":"icon_url","type":"string"},{"name":"xoul_voice_id","type":["string","null"]},{"name":"narrator_voice","type":["string","null"]},{"name":"auto_respond","type":"boolean"},{"name":"narrate","type":"boolean","default":false},{"name":"xouls","type":{"type":"array","items":{"type":"record","name":"XoulBriefConversation","fields":[{"name":"slug","type":"string"},{"name":"name","type":"string"},{"name":"icon_url","type":["null","string"],"default":null},{"name":"voice_id","type":["string","null"]},{"name":"talkativeness","type":"double"},{"name":"tagline","type":["string","null"]},{"name":"age","type":["int","null"]},{"name":"bio","type":["null","string"],"default":null},{"name":"backstory","type":"string"},{"name":"gender","type":"string"},{"name":"samples","type":["null","string"],"default":null}]},"name":"xoul"}},{"name":"personas","type":{"type":"array","items":{"type":"record","name":"PersonaBriefConversation","fields":[{"name":"slug","type":{"type":"string","logicalType":"uuid"}},{"name":"name","type":"string"},{"name":"icon_url","type":["string","null"]},{"name":"prompt","type":["string","null"]},{"name":"user_slug","type":"string"},{"name":"gender","type":"string"},{"name":"privilege","type":"string"}]},"name":"persona"}},{"name":"scenario","type":[{"type":"record","name":"ScenarioBriefConversation","fields":[{"name":"slug","type":[{"type":"string","logicalType":"uuid"},"null"]},{"name":"name","type":["string","null"]},{"name":"prompt","type":[{"type":"array","items":"string","name":"prompt"},"null"]},{"name":"icon_url","type":[{"type":"array","items":"string","name":"icon_url"},"null"]}]},"string","null"]},{"name":"objective","type":["null",{"type":"record","name":"ObjectiveAvro","fields":[{"name":"description","type":["null","string"],"default":null},{"name":"meters","type":{"type":"array","items":{"type":"record","name":"MeterAvro","fields":[{"name":"name","type":"string"},{"name":"description","type":"string"},{"name":"value","type":"int"}]},"name":"meter"}}]}],"default":null},{"name":"invite_code","type":["null","string"],"default":null},{"name":"audio_autoplay","type":"boolean","default":false},{"name":"lorebook_slug","type":["null",{"type":"string","logicalType":"uuid"}],"default":null},{"name":"lorebook","type":["null",{"type":"record","name":"BriefAssetAvro","fields":[{"name":"slug","type":{"type":"string","logicalType":"uuid"}},{"name":"name","type":"string"},{"name":"description","type":"string"},{"name":"icon_url","type":["null","string"],"default":null},{"name":"creator_slug","type":"string"},{"name":"asset_type","type":"string"}]}],"default":null},{"name":"greeter","type":["null","string"],"default":null},{"name":"greeting","type":["null","string"],"default":null},{"name":"llm_engine","type":["null","string"],"default":null},{"name":"talking_style","type":"string"}]}},{"name":"updated_conversation","type":"boolean","default":true}]},{"type":"record","name":"UserJoined","fields":[{"name":"user_slug","type":"string"},{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"timestamp","type":{"type":"long","logicalType":"timestamp-millis"}},{"name":"action","type":"string"}]},{"type":"record","name":"UserLeft","fields":[{"name":"user_slug","type":"string"},{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"timestamp","type":{"type":"long","logicalType":"timestamp-millis"}},{"name":"action","type":"string"},{"name":"leave","type":"null","default":null}]},{"type":"record","name":"InviteCode","fields":[{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"timestamp","type":{"type":"long","logicalType":"timestamp-millis"}},{"name":"invite_code","type":"string"}]},{"type":"record","name":"AvroManualMemory","fields":[{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"content","type":"string"}]},{"type":"record","name":"CreatedConversation","fields":[{"name":"conversation","type":"ConversationMultiDetails"},{"name":"timestamp","type":{"type":"long","logicalType":"timestamp-millis"}}]},{"type":"record","name":"XoulSocketSuccessResponse","fields":[{"name":"response","type":"string"}]},{"type":"array","items":{"type":"record","name":"RecentConversation","fields":[{"name":"conversation","type":"ConversationMultiDetails"},{"name":"message","type":"MessagePublic"}]},"name":"inner"},{"type":"record","name":"RetrieveChatHistoryResponse","fields":[{"name":"conversation_id","type":{"type":"string","logicalType":"uuid"}},{"name":"history","type":{"type":"array","items":"MessagePublic","name":"history"}}]},{"type":"record","name":"XoulSocketExceptionResponse","fields":[{"name":"detail","type":"string"},{"name":"error","type":"string"}]},{"type":"record","name":"RefreshConversationResponse","fields":[{"name":"conversation_ids","type":{"type":"array","items":{"type":"string","logicalType":"uuid"},"name":"conversation_id"}}]}]}]}');var o=n(44134).Buffer;let l=s().types.LongType.__with({fromBuffer:e=>e.readBigInt64LE(),toBuffer:e=>{let t=o.alloc(8);return t.writeBigInt64LE(e),t},fromJSON:BigInt,toJSON:Number,isValid:e=>"bigint"==typeof e,compare:(e,t)=>e===t?0:e<t?-1:1});class u extends s().types.LogicalType{_fromValue(e){return new Date(e).toISOString()}}let c=s().Type.forSchema(i,{registry:{long:l},logicalTypes:{"timestamp-millis":u}});var y=n(31530),m=n(44134).Buffer;let p=e=>{let t=m.from(e),n=c.fromBuffer(t).inner,a="XoulSocketExceptionResponse"in n,r=Object.values(n)[0];if(a)throw r;return r},d=(e,t)=>{let n=e=>{try{let n=p(e);t(n)}catch(e){console.log("socketOn error",e),y.Ay.error("connection refused, please refresh the page")}};return a.s.on(e,n),()=>{a.s.off(e,n)}},g=(e,t)=>new Promise((n,r)=>{a.s.timeout(1e6).emit(e,t,(e,t)=>{if(e)r(e);else try{let e=p(t);n(e)}catch(e){r(e)}})}),v=e=>{let t=(t,n)=>{try{let a=p(n);e(t,a)}catch(e){}};return a.s.onAny(t),()=>{a.s.offAny(t)}},f=e=>{let t=t=>{try{p(t)}catch(t){e(t)}};return a.s.on("exception",t),()=>{a.s.off("exception",t)}}},16347:(e,t,n)=>{n.d(t,{v:()=>a});var a=function(e){return e.USER_NOT_FOUND="user-not-found",e.USER_NOT_REGISTERED="user-not-registered",e.USER_WRONG_METHOD="user-wrong-method",e.USER_IS_INACTIVE="user-is-inactive",e.AUTH_TOKEN_ERROR="auth-token-error",e.WAITLIST_NOT_FOUND="waitlist-not-found",e.USER_NOT_FOUND_BUT_WAITLIST_PREAPPROVED="user-not-found-but-waitlist-preapproved",e}({})},18668:(e,t,n)=>{n.d(t,{SK:()=>h,cC:()=>C,xt:()=>D,Ks:()=>S,lf:()=>w,nQ:()=>F,Hj:()=>b,ki:()=>R,OU:()=>O,kY:()=>T,Tl:()=>E,t1:()=>Q,J5:()=>I,VH:()=>P,NA:()=>M});var a=n(84197),r=n(26715),s=n(95838),i=n(5041),o=n(74532);n(32205);var l=n(35695),u=n(60134),c=n(83488);async function y(e){let t,{body:n,onReadConversation:a,onReadGreeting:r}=e,s=!0;return await (0,c.y)({url:"/api/v1/conversation",method:"POST",body:JSON.stringify(n),onmessage:e=>{let n=JSON.parse(e.data);if(s){if(s=!1,!(t=JSON.parse(n.content)))return;a(t)}else{if(!t)return;r(n.content,t)}}}),t}var m=n(9136),p=n(7303),d=n(41068),g=n(92957),v=n(12115),f=n(31530),_=n(40364);let h=async function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let r=await a.rP.conversationDetails(...t),s=(0,p.Ac)(r);return s.scenario&&"object"==typeof s.scenario?{...s,scenario:{...s.scenario,icon_url:s.scenario.icon_url||[],prompt:s.scenario.prompt||[]}}:s},b=()=>{let{data:e,isLoading:t}=(0,u.sb)(),n=(0,r.useQueryClient)(),i=(0,s.useQuery)({queryKey:["conversation-listing"],refetchOnWindowFocus:"always",queryFn:async()=>{let e=(await a.rP.conversationList()).map(e=>({...e,message:{...e.message,message_id:BigInt(0),references_id:BigInt(0)}})),t=(0,p.fx)(e);return t.forEach(e=>{n.setQueryData(["conversation",e.conversation.conversation_id,"details"],e.conversation)}),t},enabled:(null==e?void 0:e.status)==="operational"});return{...i,isLoading:i.isLoading||t}},w=e=>{let t=["conversation",e,"details"];return(0,s.useQuery)({queryKey:t,refetchOnWindowFocus:"always",queryFn:()=>h(e),enabled:!!e})},D=()=>{let e=(0,r.useQueryClient)(),t=(0,l.useRouter)(),n=n=>{let{conversation:a}=n;d.g.add(()=>{let n=(0,p.jE)(a),r=(0,p.ei)(a);e.setQueryData(["conversation-listing"],e=>{if(e)return[{conversation:{...a,isMulti:n,isMultiUser:r},message:{message_id:BigInt(0),conversation_id:a.conversation_id,timestamp:new Date().toISOString(),status:"created",author_slug:"",author_type:"user",author_name:"",content_type:"text",content:""}},...e]}),e.setQueryData(["conversation",a.conversation_id,"details"],{...a,isMulti:n,isMultiUser:r}),e.setQueryData(["chat",a.conversation_id,"status"],r||a.greeting?"pending":"typing"),e.setQueryData(["chat",a.conversation_id],{pages:[[{role:"assistant",turn_id:0,content:"",timestamp:new Date().toISOString(),regenerateIndex:0,streamingStatus:"typing"}]],pageParams:[0]}),t.push("/chats/"+a.conversation_id)})},a=(t,n)=>{d.g.add(()=>{t&&(e.setQueryData(["chat",n.conversation.conversation_id,"status"],"streaming"),e.setQueryData(["chat",n.conversation.conversation_id],e=>{if(e)return(0,o.jM)(e,e=>{let n=e.pages[0][0];n&&(n.content=t,n.streamingStatus="streaming")})}))})};return(0,i.useMutation)({mutationFn:e=>y({body:e,onReadConversation:n,onReadGreeting:a}),onSuccess:t=>{d.g.add(()=>{e.setQueryData(["chat",null==t?void 0:t.conversation.conversation_id,"status"],"completed"),e.setQueryData(["chat",null==t?void 0:t.conversation.conversation_id],e=>{if(e)return(0,o.jM)(e,e=>{let t=e.pages[0][0];t&&(t.streamingStatus="completed")})});let n=e.getQueryData(["chat",null==t?void 0:t.conversation.conversation_id]);if(n){let a=n.pages[0][0];e.setQueryData(["conversation-listing"],e=>{if(e)return(0,o.jM)(e,e=>{let n=e.find(e=>e.conversation.conversation_id===(null==t?void 0:t.conversation.conversation_id));n&&(null==a?void 0:a.timestamp)&&(n.message.content=a.content,n.message.timestamp=a.timestamp)})})}})}})},S=()=>{let e=(0,r.useQueryClient)();return(0,i.useMutation)({mutationFn:a.rP.conversationDelete,onSuccess:(t,n)=>{e.setQueryData(["conversation-listing"],e=>{if(e)return e.filter(e=>e.conversation.conversation_id!==n)})}})},T=()=>{let e=(0,r.useQueryClient)();return(0,i.useMutation)({mutationFn:a.rP.conversationUpdate,onSuccess:async(t,n)=>{let{conversation_id:r,xoul_voice_id:s,narrate:i,narrator_voice:o,audio_autoplay:l,auto_respond:u,llm_engine:c,talking_style:y,lorebook_slug:m}=n,p=await e.fetchQuery({queryKey:["asset",m],queryFn:async()=>{if(m)return await a.IC.assetRead(m)}});e.setQueryData(["conversation",r,"details"],e=>{if(e)return{...e,narrate:null!=i?i:e.narrate,audio_autoplay:null!=l?l:e.audio_autoplay,xoul_voice_id:null!=s?s:e.xoul_voice_id,llm_engine:null!=c?c:e.llm_engine,talking_style:null!=y?y:e.talking_style,lorebook_slug:m,lorebook:p?{asset_type:p.asset_type,creator_slug:p.creator_slug,description:p.description,name:p.name,slug:p.slug,icon_url:p.icon_url}:null,narrator_voice:null!=o?o:e.narrator_voice}})}})},Q=()=>{let e=(0,r.useQueryClient)();return(0,i.useMutation)({mutationFn:async e=>{let{conversation_id:t,operator:n,xouls:r}=e;return a.rP.conversationUpdateXouls({conversation_id:t,operator:n,xouls:r})},onSuccess:(t,n)=>{let{conversation_id:a,xouls:r,operator:s}=n;e.setQueryData(["conversation",a,"details"],e=>{if(e)return(0,o.jM)(e,e=>{e.xouls=t})})}})},E=()=>{let e=(0,r.useQueryClient)();return{updateLastMessage:(0,v.useCallback)(t=>{e.setQueryData(["conversation-listing"],e=>{if(e)return(0,o.jM)(e,e=>{let n=e.find(e=>e.conversation.conversation_id===t.conversation_id);n&&(n.message.content=t.content,n.message.timestamp=t.timestamp),e.sort((e,t)=>e.message.timestamp&&t.message.timestamp?(0,g.T)(e.message.timestamp,t.message.timestamp):0)})})},[e])}},M=()=>{let e=(0,r.useQueryClient)(),{data:t,isLoading:n}=(0,u.sb)(),a=(0,l.useRouter)();(0,v.useEffect)(()=>(0,m.zj)("user",r=>{let s=["conversation",r.conversation_id,"details"],i=e.getQueryData(s),l=null==i?void 0:i.personas.find(e=>e.user_slug===r.user_slug);if("leave"===r.action){let u=(null==t?void 0:t.slug)===r.user_slug&&!n,c=(0,o.jM)(i,e=>{e&&(e.personas=e.personas.filter(e=>e.user_slug!==r.user_slug))});if(!u&&l&&f.Ay.success("".concat(l.name," has left the conversation")),u){let t=e.getQueryData(["conversation-listing"]),n=(0,o.jM)(t,e=>{if(e)return e.filter(e=>e.conversation.conversation_id!==r.conversation_id)});e.setQueryData(["conversation-listing"],n),a.replace("/chats")}e.setQueryData(s,c)}}))},P=()=>{let e=(0,r.useQueryClient)();(0,v.useEffect)(()=>(0,m.zj)("update_conversation",t=>{let n=["conversation",t.conversation_id,"details"],a=e.getQueryData(n);if("invite_code"in t){let r=(0,o.jM)(a,e=>{e&&(e.invite_code=t.invite_code)});e.setQueryData(n,r)}else e.setQueryData(n,{...t.conversation,isMultiUser:t.conversation.personas.length>1,isMulti:t.conversation.xouls.length>1})}))},R=e=>(0,s.useQuery)({queryKey:["conversation",e,"manual-memory"],refetchOnWindowFocus:"always",queryFn:async()=>({content:(await a.rP.conversationGetManualMemory(e)).content.trimEnd()}),enabled:!!e}),O=e=>{let t=(0,r.useQueryClient)();return(0,i.useMutation)({mutationFn:t=>a.rP.conversationReplaceManualMemory(e,t),onMutate:async n=>{let{content:a}=n;await t.cancelQueries({queryKey:["conversation",e,"manual-memory"]});let r=t.getQueryData(["conversation",e,"manual-memory"]);return t.setQueryData(["conversation",e,"manual-memory"],{content:a}),{snapshot:r}},onError:(n,a,r)=>{f.Ay.error("something went wrong, we couldn't update your memory."),t.setQueryData(["conversation",e,"manual-memory"],null==r?void 0:r.snapshot)}})},C=e=>{let t=(0,r.useQueryClient)();return(0,i.useMutation)({mutationFn:t=>a.rP.conversationAppendManualMemory(e,t),onMutate:async n=>{let{content:a}=n;await t.cancelQueries({queryKey:["conversation",e,"manual-memory"]});let r=t.getQueryData(["conversation",e,"manual-memory"]);return t.setQueryData(["conversation",e,"manual-memory"],(0,o.jM)(r,e=>{if(!e)return{content:a};e.content="".concat(e.content,"\n").concat(a)})),{snapshot:r}},onSuccess:n=>{let{content:a}=n;t.setQueryData(["conversation",e,"manual-memory"],{content:a.trimEnd()})},onError:(n,a,r)=>{f.Ay.error("Something went wrong, we couldn't update your memory."),t.setQueryData(["conversation",e,"manual-memory"],null==r?void 0:r.snapshot)}})},F=()=>{let e=(0,r.useQueryClient)();return(0,i.useMutation)({mutationFn:e=>(0,m.X6)("join_conversation",{invite_code:e}),onSuccess:t=>{e.invalidateQueries({queryKey:["conversation-listing"]})}})},I=()=>{let e=(0,r.useQueryClient)();(0,v.useEffect)(()=>(0,m.zj)("manual_memory",t=>{d.g.add(async()=>{let n=await e.fetchQuery({queryKey:["conversation",t.conversation_id,"details"]}),a=await e.fetchQuery({queryKey:["user"]});(0,_.du)(n.personas,a.slug)||e.setQueryData(["conversation",t.conversation_id,"manual-memory"],{content:t.content.trimEnd()})})}))}},27316:(e,t,n)=>{n.d(t,{D:()=>a});let a=e=>{window.ReactNativeWebView&&window.ReactNativeWebView.postMessage(JSON.stringify(e))}},31293:(e,t,n)=>{n.d(t,{O5:()=>y,UC:()=>s,X5:()=>c,aI:()=>u,oW:()=>m,y4:()=>i});var a=n(8594);let r=/(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?])/,s=a.z.object({email:a.z.string(),has_password:a.z.boolean(),site_permissions:a.z.array(a.z.string()).default([])}),i=a.z.object({email:a.z.string().email()}),o=a.z.object({password:a.z.string().min(1)}),l=a.z.object({password:a.z.string().min(8,"Password must be at least 8 characters long").refine(e=>/[a-z]/.test(e),{message:"Password must include a lowercase letter"}).refine(e=>/[A-Z]/.test(e),{message:"Password must include an uppercase letter"}).refine(e=>/[0-9]/.test(e),{message:"Password must include a number"}).refine(e=>r.test(e),{message:"Password must include a special characters (e.g. !@#$%^&*)"})}),u=a.z.object({password:a.z.string()}),c=i.merge(o),y=i.merge(l),m=l.merge(a.z.object({confirm_password:a.z.string()})).refine(e=>e.password===e.confirm_password,{message:"Password doesn't match",path:["confirm_password"]})},41068:(e,t,n)=>{n.d(t,{g:()=>a});let a=new(n(8503)).A({concurrency:1,interval:50,intervalCap:1})},49895:(e,t,n)=>{n.d(t,{i:()=>s,V:()=>i});let a=n(8594).z.enum(["web","android","ios"]).catch("web");var r=n(95838);let s=()=>a.parse(window.PLATFORM),i=()=>(0,r.useQuery)({queryKey:["platform"],queryFn:s})},50210:(e,t,n)=>{n.d(t,{n8:()=>i,ug:()=>o});var a=n(18835),r=n(57383),s=n(31293);let i=function(){let{return_to:e=a.K.WEBSITE_URL+"/",connection:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=a.K.REST_API_ENDPOINT,r=new URL(e);r.searchParams.set("is_auth_redirect","true");let s=new URL(e);s.searchParams.set("open_login","true");let i=new URL("/api/v1/auth/idp/authorize",n);return i.searchParams.set("success_url",r.toString()),i.searchParams.set("failure_url",s.toString()),t&&i.searchParams.set("provider",t),i.toString()},o=async()=>{let e=r.A.get("xoul_backend_userinfo");if(e)try{let t=JSON.parse(e);return s.UC.parse(t)}catch(e){}}},51571:(e,t,n)=>{n.d(t,{Ey:()=>y,VX:()=>m,W4:()=>g,_i:()=>c,gU:()=>p,z_:()=>d});var a=n(2304),r=n(84197),s=n(27316),i=n(26715),o=n(5041),l=n(35695),u=n(31530);let c=()=>{let e=(0,l.useRouter)(),t=(0,i.useQueryClient)();return(0,o.useMutation)({mutationFn:()=>r.uR.authLogout(),onSuccess(){(0,s.D)({event:"logout"}),t.clear(),a.s.disconnect(),e.replace("/"),e.refresh()}})},y=()=>(0,o.useMutation)({mutationFn:r.uR.authSignup,meta:{disableOnError:!0}}),m=()=>{let e=(0,i.useQueryClient)();return(0,o.useMutation)({mutationFn:r.uR.authLoginPassword,onSuccess:()=>{e.refetchQueries({queryKey:["user-info-cookie"]})},meta:{disableOnError:!0}})},p=()=>(0,o.useMutation)({mutationFn:r.uR.authPasswordReset,meta:{disableOnError:!0}}),d=()=>(0,o.useMutation)({mutationFn:e=>{let{token:t,password:n}=e;return r.uR.authPasswordResetCallback(t,{password:n})}}),g=()=>{let e=(0,l.useRouter)();return(0,o.useMutation)({mutationFn:async e=>{let t=await fetch("/api/auth/password-protection",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("Invalid password");return t},onSuccess:()=>{e.push("/")},onError:()=>{u.Ay.error("Invalid password")},meta:{disableOnError:!0}})}},60134:(e,t,n)=>{n.d(t,{CR:()=>E,Jd:()=>T,VH:()=>C,Y6:()=>N,YG:()=>P,bw:()=>I,im:()=>w,qB:()=>Q,sb:()=>S,to:()=>D,ug:()=>M,v$:()=>R,x:()=>O,zY:()=>F});var a=n(84197),r=n(50210),s=n(16347),i=n(95838),o=n(52020),l=n(26715),u=n(5041),c=n(48822),y=n(12115),m=n(57383),p=n(31293),d=n(62105),g=n(6042),v=n(51571),f=n(60784),_=n.n(f),h=n(49895),b=n(2304);let w=e=>{let{platform:t,logout:n}=e,a=m.A.get("xoul_backend_userinfo");if(!a)return"web"!==t&&n(),null;try{let e=JSON.parse(a);return p.UC.parse(e)}catch(e){n()}},D=()=>{let{mutate:e}=(0,v._i)(),{data:t}=(0,h.V)();return(0,i.useQuery)({queryKey:["user-info-cookie"],queryFn:t?()=>w({platform:t,logout:e}):o.hT,enabled:!!t})},S=()=>{let{data:e}=D(),{mutate:t}=(0,v._i)(),n=(0,i.useQuery)({queryKey:["user"],queryFn:a.DL.userProfile,enabled:!!e});return(0,y.useEffect)(()=>{var e,a,i;if(n.error){if((null==(e=n.error)?void 0:e.error)==="user-deactivated")return void t();(null==(a=n.error)?void 0:a.error)!==s.v.USER_NOT_FOUND&&(null==(i=n.error)?void 0:i.error)!==s.v.USER_NOT_FOUND_BUT_WAITLIST_PREAPPROVED&&(0,r.ug)().then(e=>{(null==e?void 0:e.email)&&d.wd("/self endpoint issue, user: ".concat(e.email,", error=").concat(n.error),"debug")})}},[n.error,t]),n},T=e=>(0,i.useQuery)({queryKey:["user",e],queryFn:()=>a.DL.userRead(e),enabled:!!e}),Q=()=>{let e=(0,l.useQueryClient)(),{data:t}=S();return(0,u.useMutation)({mutationFn:a.DL.userUpdate,onSuccess:(n,a)=>{e.setQueryData(["user"],a),e.setQueryData(["user",null==t?void 0:t.slug],e=>{if(e)return{...e,...a}})}})},E=()=>{let e=(0,l.useQueryClient)();return(0,u.useMutation)({mutationFn:a.DL.userRegister,onSuccess:()=>{e.refetchQueries({queryKey:["user"],exact:!0}),b.s.connect()},retry:2,meta:{disableOnError:!0}})},M=e=>{let t=(0,g.d7)(e,500);return(0,i.useQuery)({queryKey:["user-availability",t],queryFn:()=>a.DL.userSlugAvailability(t),select:e=>e.available,enabled:!!t&&t.length>=6&&t.length<=30})},P=()=>(0,i.useQuery)({queryKey:["user-usage"],queryFn:()=>a.DL.userUsage()}),R=()=>{let{mutate:e}=(0,v._i)();return(0,u.useMutation)({mutationFn:a.DL.userDeactivate,onSuccess:()=>{e()},meta:{disableOnError:!0}})},O=()=>{var e,t;let n=S(),a=(null==(e=n.error)?void 0:e.error)===s.v.USER_NOT_FOUND||(null==(t=n.error)?void 0:t.error)===s.v.USER_NOT_FOUND_BUT_WAITLIST_PREAPPROVED;return{...n,data:a}},C=()=>{let{data:e,isLoading:t}=S(),n=(0,i.useQuery)({queryKey:["referral"],queryFn:a.DL.userGetReferralCode,enabled:!!e});return{...n,isLoading:n.isLoading||t}},F=function(){let{q:e="",limit:t,enabled:n=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,i.useQuery)({queryKey:["user-search",e],queryFn:()=>a.DL.userSimpleSearch(t,e),select:e=>e.items,enabled:n})},I=function(){let{creator:e="pub",filter_following:t,filter_tags:n=[],enabled:r=!0,orderby:s="created_at_desc",limit:i=20,cursor:o}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,c.useInfiniteQuery)({queryKey:["user-slist",e,t,n,s],queryFn:async r=>{let{pageParam:o}=r;return await a.DL.userSimpleListing(s,o,i,e,t,n)},getNextPageParam:e=>{if(!(e.items.length<i))return e.items[e.items.length-1].slug},initialPageParam:o,select:e=>e.pages.flatMap(e=>e.items),enabled:r})},N=function(){let{limit:e=20,randomize:t=!1,enabled:n=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,c.useInfiniteQuery)({queryKey:["user-tags",{limit:e}],queryFn:async n=>{let{pageParam:r}=n,s=await a.DL.userFacets("tag",r||null,e);if(t){var i;return{items:_()(s.items),lastItemSlug:null==(i=s.items.at(-1))?void 0:i.item}}return s},initialPageParam:"",getNextPageParam:t=>{var n;if(!(t.items.length<e))return"lastItemSlug"in t?null==t?void 0:t.lastItemSlug:null==(n=t.items.at(-1))?void 0:n.item},select:e=>e.pages.flatMap(e=>e.items),enabled:n})}},83488:(e,t,n)=>{n.d(t,{y:()=>s});var a=n(95069),r=n(18835);async function s(e){let{url:t,onopen:n=async e=>{if(!e.ok)throw await e.json()},...s}=e,i="".concat(r.K.REST_API_ENDPOINT).concat(t);await (0,a.y)(i,{headers:{"Content-Type":"application/json"},credentials:"include",openWhenHidden:!0,onopen:n,onerror(e){throw e},...s})}}}]);